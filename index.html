<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Contacts Local</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
body {
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #111;
    font-family: Arial, sans-serif;
    color: white;
}

#photoPage { display: none; flex-direction: column; align-items: center; }

button {
    margin-top: 20px;
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 16px;
}

pre {
    margin-top: 20px;
    max-height: 300px;
    overflow: auto;
    background: #222;
    padding: 15px;
    border-radius: 10px;
    width: 400px;
}
</style>
</head>

<body>

<div id="loginPage">
    <h2>Connexion Google</h2>
    <div id="g_id_onload"
         data-client_id="739861507841-mnmfem8pjmcemo48ufsckgkqvtoec8j6.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>

    <div class="g_id_signin"
         data-type="standard"
         data-size="large">
    </div>
</div>

<div id="photoPage">
    <h2>Connecté ✅</h2>
    <button onclick="getContacts()">Récupérer mes contacts</button>
    <pre id="contactsResult"></pre>
</div>

<script>

// Connexion Google
function handleCredentialResponse(response) {
    const jwt = response.credential;
    const payload = JSON.parse(atob(jwt.split('.')[1]));

    console.log("Connecté :", payload.email);

    localStorage.setItem("google_user", JSON.stringify(payload));
    showPhotoPage();
}

function showPhotoPage() {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("photoPage").style.display = "flex";
}

// Vérifie si déjà connecté
window.addEventListener("load", function() {
    const user = localStorage.getItem("google_user");
    if (user) {
        showPhotoPage();
    }
});

// Demande accès aux contacts
function getContacts() {

    const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: "739861507841-mnmfem8pjmcemo48ufsckgkqvtoec8j6.apps.googleusercontent.com",
        scope: "https://www.googleapis.com/auth/contacts.readonly",
        callback: (tokenResponse) => {
            fetchContacts(tokenResponse.access_token);
        }
    });

    tokenClient.requestAccessToken();
}

// Récupération via People API
function fetchContacts(accessToken) {
    fetch("https://people.googleapis.com/v1/people/me/connections?personFields=names,emailAddresses", {
        headers: {
            Authorization: "Bearer " + accessToken
        }
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("contactsResult").textContent =
            JSON.stringify(data, null, 2);
    })
    .catch(err => {
        console.error(err);
        alert("Erreur lors de la récupération des contacts");
    });
}

</script>

</body>
</html>
